# rollun-datastore

`rollun-datastore` - это библиотека, которая предоставляет единый интерфейс взаимодействие с любым хранилищем данных
на основе [Resource Query Language (RQL)](https://www.sitepen.com/blog/2010/11/02/resource-query-language-a-query-language-for-the-web-nosql/).
Существующие реализации: DbTable (для таблицы бд), CsvBase (для csv файлов), HttpClient (для внешнего ресурса через 
http), Memory (для [RAM](https://en.wikipedia.org/wiki/Random-access_memory)).

* [Документация](docs/index.md)
* [Поддерживаемые запросы к датасторам и их методы](https://docs.google.com/spreadsheets/d/1UknTHmrL8HaCDPefSGKUoMysKwInPynrTOQwRd62e2U/edit?usp=sharing)

## Краткая таблица операций

| Операция | HTTP | RQL (в query)                      | Тело запроса | Примечания                                                                                                                                                   |
|---|---|------------------------------------|---|--------------------------------------------------------------------------------------------------------------------------------------------------------------|
| Получить запись (`read`) | GET | Нет                                | — | **Требуется ID (в path).**                                                                                                                                   |
| Поиск (`query`) | GET | Обязателен | — | —                                                                                                                                                            |
| Скачать CSV | GET | Можно | — | `Accept: text/csv`. При экспорте **RQL-ограничение `limit(...)` принудительно снимается обработчиком CSV**, поэтому возвращается **весь** контент датастора. |
| Создать (`create`) | POST | Нет                                | Объект | При коллизии ID поведение задаёт **`overwriteMode`**: `false` — ошибка; `true` — перезаписать существующую запись.                                           |
| Множественное создание (`multiCreate`) | POST | Нет                                | **Массив** объектов | Если пакетное создание не поддержано, выполняются последовательные вызовы `create()` для каждого элемента.                                                   |
| Обновить (`update`) | PUT | Нет                                | Объект | **ID обязателен**; если указан и в path, и в body — приоритет у body. **Upsert при `overwriteMode=true`** (создать, если записи нет).                        |
| Обновить по фильтру (`queriedUpdate`) | PATCH | Обязателен | Объект | **Требуется `limit`**; **нельзя** `select`/`groupBy`; **без** PK (первичный ключ) в body.                                                                    |
| Удалить (`delete`) | DELETE | Нет                                | — | **Требуется ID (в path).**                                                                                                                                   |
| HEAD (`getIdentifier`) | HEAD | Нет                                | — | Метаданные/хедеры по PK.                                                                                                                                     |
| Refresh (если поддерживается) | PATCH | Нет                                | — | Только для датасторов с `RefreshableInterface`.                                                                                                              |

### Примечания к таблице

**overwriteMode** — атрибут запроса (`$request->getAttribute('overwriteMode')`), булев флаг, задающий поведение при конфликте/отсутствии записи:  
— в `create`: `false` — при дубле ID ошибка; `true` — перезаписать существующую запись.  
— в `update`: `false` — обновлять только существующую; `true` — создать, если отсутствует (upsert).

**CSV и LIMIT** — при экспорте CSV обработчик принудительно снимает/заменяет клиентский `limit(...)` на «без ограничений», поэтому выгружается всё (это поведение реализовано в CSV-хендлере).

## [Расширенный формат таблицы выше](/docs/datastore_methods.md)

### Для сторонних клиентов

В DataStore используется дополненная версия `rawurlencode`.
К перечню стандартных символов добавлены следующие преобразования

* `-` => `%2D`
* `_` => `%5F`
* `.` => `%2E`
* `~` => `%7E`
