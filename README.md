# rollun-datastore

`rollun-datastore` - это библиотека, которая предоставляет единый интерфейс взаимодействие с любым хранилищем данных
на основе [Resource Query Language (RQL)](https://www.sitepen.com/blog/2010/11/02/resource-query-language-a-query-language-for-the-web-nosql/).
Существующие реализации: DbTable (для таблицы бд), CsvBase (для csv файлов), HttpClient (для внешнего ресурса через 
http), Memory (для [RAM](https://en.wikipedia.org/wiki/Random-access_memory)).

* [Документация](docs/index.md)
* Опис історії змін по версіям [CHANGELOG.md](CHANGELOG.md)
* [Поддерживаемые запросы к датасторам и их методы](https://docs.google.com/spreadsheets/d/1UknTHmrL8HaCDPefSGKUoMysKwInPynrTOQwRd62e2U/edit?usp=sharing)

## Краткая таблица операций

| Операция                                  | HTTP | RQL (в query) | Тело запроса | Примечания                                                                                                                                                                                     | Заголовки и атрибуты запроса                                                        | Ограничения и известные проблемы                                                                                                                                                                                                                               |
|-------------------------------------------|---|---|---|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|-------------------------------------------------------------------------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| Получение записи (read)                   | GET | Нет | — | **Требуется ID (в path).**                                                                                                                                                                     | **Требуется** атрибут `primaryKeyValue`                                             | —                                                                                                                                                                                                                                                              |
| Поиск (query)                             | GET | Обязателен | — | —                                                                                                                                                                                              | Атрибут `primaryKeyValue` **должен отсутствовать**                                  | —                                                                                                                                                                                                                                                              |
| Загрузить контент в CSV                   | GET | Можно | — | При экспорте **RQL-ограничение limit(...) принудительно снимается обработчиком CSV**, поэтому возвращается **весь** контент датастора.                                                         | **Требуется** заголовок `download` со значением `csv`                               | В данный момент ситуация с `limit` это баг и о нём известно. Требуемый заголовок также в дальнейшем будет изменен согласно стандартам (`Accept: text/csv`).                                                                                                    |
| Создание записи (create)                  | POST | Нет | Объект | При коллизии ID поведение задаёт **overwriteMode**: false — ошибка; true — перезаписать существующую запись. Если PK указан и в `path`, и в `body` — приоритет у `body` (**НУЖНО ПРОВЕРИТЬ**). | **Опционально** атрибут `overwriteMode`. **Опционально** атрибут `primaryKeyValue`. | Если PK нет ни в `body`, ни в `path`, то попытка создания записи все равно произойдет для `DbTable`. Это может вызвать ошибку если PK не `AUTO_INCREMENT`. `overwriteMode` вызывает ошибку уровня deprecated для DbTable и по умолчанию имеет значение `false` |
| Множественное создание (multiCreate)      | POST | Нет | **Массив** объектов | Если пакетное создание не поддержано, выполняются последовательные вызовы create() для каждого элемента.                                                                                       | —                                                                                   | —                                                                                                                                                                                                                                                              |
| Обновление записи (update)                | PUT | Нет | Объект | **ID обязателен**; если указан и в path, и в body — приоритет у body. **Upsert при `overwriteMode = true`** (создать, если записи нет).                                                        | **Опционально** атрибут `overwriteMode`. **Опционально** атрибут `primaryKeyValue`. | `overwriteMode` вызывает ошибку уровня deprecated для DbTable и по умолчание имеет значение `false`. Согласно стандартам, **частичное** обновление записи должно выполнятся методом `PATCH` - об этом известно.                                                 |
| Обновление по фильтру (queriedUpdate)     | PATCH | Обязателен | Объект | **Требуется наличие limit в RQL**; **нельзя** select/groupBy; **без** PK (первичный ключ) в body.                                                                                              | Атрибут `primaryKeyValue` **должен отсутствовать**                                  | Для `DbTable` обновление по фильтру выполняется с помощью `SELECT FOR UPDATE`.                                                                                                                                                                                 |
| Удалени (delete)                          | DELETE | Нет | — | **Требуется ID (в path).**                                                                                                                                                                     | **Требуется** атрибут `primaryKeyValue`.                                            | Для `DbTable` переданный в запросе PK быть либо типа `integer`, либо `double`, либо `string`.                                                                                                                                                                  |
| Получение метаданных (getIdentifier)      | HEAD | Нет | — | Метаданные/хедеры по PK.                                                                                                                                                                       | —                                                                                   | Заголовки возвращаются в формате `X_OPE_RATION` и т.д.                                                                                                                                                                                                         |
| Refresh (если поддерживается)             | PATCH | Нет | — | Только для датасторов с `RefreshableInterface`.                                                                                                                                                | —                                                                                   | —                                                                                                                                                                                                                                                              |
| Множественное обновление (multiUpdate)    |       |     |   | В данный момент не реализовано                                                                                                                                                                  |                                                                                     |                                                                                                                                                                                                                                                                |
| Удаление всех записей (deleteAll)         |       |     |   | В данный момент не реализовано                                                                                                                                                                                               |                                                                                     |                                                                                                                                                                                                                                                                |
| Пересоздание записи (rewrite)             |       |     |   | В данный момент не реализовано                                                                                                                                                                                               |                                                                                     |                                                                                                                                                                                                                                                                |
| Множественное пересоздание (multiRewrite) |       |     |   | В данный момент не реализовано                                                                                                                                                                                               |                                                                                     |                                                                                                                                                                                                                                                                |
| Удаление по фильтру (queriedDelete)       |       |     |   | В данный момент не реализовано                                                                                                                                                                                               |                                                                                     |                                                                                                                                                                                                                                                                |

### Примечания к таблице

#### Атрибут **overwriteMode** 
Это атрибут запроса (`$request->getAttribute('overwriteMode')`), булев флаг, который middleware `RequestDecoder` 
устанавливает на основании заголовка `If-Match`. Если заголовок равен `*` (`If-Match: *`) — значение `true`; 
при любом другом значении или отсутствии заголовка — `false`. Он задает поведение при конфликте/отсутствии записи.

#### **CSV и LIMIT**
При экспорте CSV обработчик принудительно снимает/заменяет клиентский `limit(...)` на «без ограничений», поэтому выгружается всё (это поведение реализовано в CSV-хендлере).

#### Атрибут **primaryKeyValue**
Это атрибут запроса (`$request->getAttribute('primaryKeyValue')`), строковый PK записи, который middleware `ResourceResolver` 
извлекает из роут-параметра `id` или из последнего сегмента пути `/api/datastore/{resourceName}/{id}` (после `rawurldecode(...)`). 
Если ID не задан — null.

## [Расширенный формат таблицы выше](/docs/datastore_methods.md)

### Для сторонних клиентов

В DataStore используется дополненная версия `rawurlencode`.
К перечню стандартных символов добавлены следующие преобразования

* `-` => `%2D`
* `_` => `%5F`
* `.` => `%2E`
* `~` => `%7E`
