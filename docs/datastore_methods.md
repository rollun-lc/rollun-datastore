# DataStore methods (HttpClient) — внутренняя справка

## Abstraction level
**Единый справочник возможностей DataStore, без привязки к HTTP и конкретной реализации**

- **[DataStoreAbstract](/src/DataStore/src/DataStore/DataStoreAbstract.php) implements both interfaces - DataStoreInterface & DataStoresInterface**
- **Realizations extends DataStoreAbstract**
- [**DataStoresInterface** - старый интерфейс, **DataStoreInterface** - более новый интерфейс](/docs/index.md#getting-started)

| Name (operation) | Request shape                                                 | Response shape               | id semantics | preconditions                                             | notes                                                                                                                                                                                 |
|------------------|---------------------------------------------------------------|------------------------------|--------------|-----------------------------------------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| Has              | `id` - идентификатор записи                                   | `bool`                       | required     | id type - `integer` \| `double` \| `string`               | Есть ли такая запись                                                                                                                                                                  |
| Read             | `id`                                                          | `array`                      | required     | id type - `integer` \| `double` \| `string`               | Использует `query` запрос с условием `Equal`                                                                                                                                          |
| GetIdentifier    | -                                                             | `"id"` - PK identifier       | -            | -                                                         | Получение идентификатора                                                                                                                                                              |
| Query            | `Query` - объект-контейнер результата парсинга RQL            | `array` - массив записей     | forbidden    | only sort ASC & DESC (+ & -)                              | Чтение с помощью `RQL` (`where`, `limit`, `sort`, `groupby`, `select`)                                                                                                                |
| Create           | `$itemData`, `$rewriteIfExist` (optional, `false` by default) | -                            | -            | `abstract public function` (contract to release in heirs) | -                                                                                                                                                                                     |
| MultiCreate      | `array` - массив объектов                                     | `array` - created rows id's  | -            | -                                                         | Циклическое использование операции создания записи, если запись не была создана - ошибка игнорируется и цикл продолжается                                                             |
| Update           | `$itemData`, `$createIfAbsent` (optional, `false` by default) | -                            | -            | `abstract public function` (contract to release in heirs) | -                                                                                                                                                                                     |
| MultiUpdate      | `array` - массив объектов                                     | `array` - updated id's       | -            | -                                                         | Циклическое использование операции обновления записи, если запись не была обновлена - ошибка игнорируется и цикл продолжается                                                         |
| QueriedUpdate    | `$record`, `Query`                                            | `array` - updated id's       | forbidden    | -                                                         | Сначала используется поиск по фильтру (`query`) - затем циклическое использование операции обновления записи, если запись не была обновлена - ошибка игнорируется и цикл продолжается |
| DeleteAll        | -                                                             | `int` - deleted items number | -            | -                                                         | Циклическое использование операции удаления записи, если запись не была удалена - ошибка игнорируется и цикл продолжается                                                             |
| Rewrite          | `array` - объект                                              | create result                | required     | -                                                         | Использование операции создания записи (если в датасторе уже присутствует такая запись, то добавляется булев флаг `rewriteIfExist`со значением `true`)                                |
| MultiRewrite     | `array[]`                                                     | `array` - rewrote id's       | required     | -                                                         | Циклическое использование операции `rewrite`, если запись не была перезаписана - ошибка игнорируется и цикл продолжается                                                              |
| Delete           | `id`                                                          | -                            | required     | `abstract public function` (contract to release in heirs) | -                                                                                                                                                                                     |
| QueriedDelete    | `Query`                                                       | `array` - deleted id's       | forbidden    | -                                                         | Сначала используется поиск по фильтру (`query`) - затем циклическое использование операции удаление записи, если запись не была удалена - ошибка игнорируется и цикл продолжается     |
| Count            | -                                                             | `int`                        | -            | -                                                         | Количество записей в датасторе                                                                                                                                                        |

## Realizations

| Name (operation) | [DbTable](/src/DataStore/src/DataStore/DbTable.php) | Notes | Preconditions | [CsvBase](/src/DataStore/src/DataStore/CsvBase.php) | [Memory](/src/DataStore/src/DataStore/Memory.php) | [HttpClient](/src/DataStore/src/DataStore/HttpClient.php) |
| --- |-----------------------------------------------------| --- | --- |-----------------------------------------------------| --- | --- |
| Read | ✅                                                   | - | identifier is only integer, double or string | ✅                                                   | ✅ | ✅ |
| GetIdentifier | ❌                                                   | - | - | ❌                                                   | ❌ | ✅ |
| Query | ✅                                                   | - | - | ❌                                                   | ❌ | ✅ |
| Create | ✅                                                   | Option 'rewriteIfExist' is no more use, E_DEPRECATED | - | ✅                                                   | ✅ | ✅ |
| MultiCreate | ✅                                                   | - | - | ❌                                                   | ❌ | ✅ |
| Update | ✅                                                   | Option 'createIfAbsent' is no more use, E_DEPRECATED | Item must has primary key | ✅                                                   | ✅ | ✅ |
| MultiUpdate | ❌                                                   | - | - | ❌                                                   | ❌ | ❌ |
| QueriedUpdate | ✅                                                   | using SELECT FOR UPDATE<br>rollback after any error | Expected non-empty associative array for update fields<br>requires limit<br>does not support select or groupBy<br>Primary key must not be present in queriedUpdate body | ❌                                                   | ❌ | ❌ |
| DeleteAll | ✅                                                   | - | - | ✅                                                   | ✅ | ❌ |
| Rewrite | ❌                                                   | - | - | ❌                                                   | ❌ | ❌ |
| MultiRewrite | ❌                                                   | - | - | ❌                                                   | ❌ | ❌ |
| Delete | ✅                                                   | - | identifier is only integer, double or string | ✅                                                   | ✅ | ✅ |
| QueriedDelete | ✅                                                   | - | Only where clause allowed for operation | ❌                                                   | ❌ | ❌ |
| Count | ✅                                                   | SELECT COUNT(*) AS count FROM table | - | ✅                                                   | ✅ | ❌ |

## HTTP callable

| HTTP method | PHP method                                   | Handler | Request | Body | Description | Request features |
| --- |----------------------------------------------| --- | --- | --- | --- | --- |
| HEAD | `getIdentifier()`                            | [HeadHandler](/src/DataStore/src/Middleware/Handler/HeadHandler.php) | HEAD / | any | get PK | - |
| GET | `read($id)`                                  | [ReadHandler](/src/DataStore/src/Middleware/Handler/ReadHandler.php) | GET /{$id} | any | Read record by PK | - |
| GET | `query(Query $query)`                        | [QueryHandler](/src/DataStore/src/Middleware/Handler/QueryHandler.php) | GET /?rql | any | Read records by RQL filter | allowed withContentRange header (items and offset) |
| GET | none                                         | [DownloadCsvHandler](/src/DataStore/src/Middleware/Handler/DownloadCsvHandler.php) | GET /?rql | any | Obtaining datastore content in CSV format<br>Header will be changed to standarst (text/csv) in next releases. | - HEADER = 'download'<br>- limit in rql will be changed by server - you'll get all the content of DataStore |
| POST | `create($itemData, $rewriteIfExist = false)` | [CreateHandler](/src/DataStore/src/Middleware/Handler/CreateHandler.php) | POST / | {<br>"id":"value" (PK),<br>notNull fields<br>} | Creating a record | allowed overwriteMode - the ability to re-create a record if such a PK already exists |
| POST | `multiCreate($records)`                      | [MultiCreateHandler](/src/DataStore/src/Middleware/Handler/MultiCreateHandler.php) | POST / | [<br>{create},<br>{create}<br>] | Create multiple records by one request | если в дс не реализован метод, циклически create |
| PUT | `update($itemData, $createIfAbsent = false)` | [UpdateHandler](/src/DataStore/src/Middleware/Handler/UpdateHandler.php) | PUT /{$id} (либо в body id} | {<br>"field":"value"<br>} | partial update, correct method is PATCH, will be fixed in next releases | - allowed overwriteMode - create an entry if the transferred PK does not yet have one<br>- If "id":"value" is specified in the request body, it takes precedence over the id from the path param |
| PATCH | `queriedUpdate($record, Query $query)`       | [QueriedUpdateHandler](/src/DataStore/src/Middleware/Handler/QueriedUpdateHandler.php) | PATCH /?limit()&rql | {<br>"field":"value"<br>} | Partial update of records matching the RQL filter conditions | Limit required |
| PATCH | `refresh()`                                  | [RefreshHandler](/src/DataStore/src/Middleware/Handler/RefreshHandler.php) | PATCH / | any | Refresh datastore contents | only if DataStore realisation implements RefreshableInterface |
| DELETE | `delete($id)`                                | [DeleteHandler](/src/DataStore/src/Middleware/Handler/DeleteHandler.php) | DELETE /{$id} | any | Delete record by PK | - |
