# DataStore methods (HttpClient) — внутренняя справка

## Interface

**Единый справочник возможностей DataStore, без привязки к HTTP и конкретной реализации**

### Interface DataStoreInterface

| Name (operation) | Request shape req | Request shape optional | Response shape | id semantics | preconditions | notes |
| --- | --- | --- | --- | --- | --- | --- |
| Create | `array`\|`\ArrayObject`\|`BaseDto`\|`object` | - | `array`\|`\ArrayObject`\|`BaseDto`\|`object` - created item | optional | - | - |
| MultiCreate | `array[]`\|`\ArrayObject[]`\|`object` | - | `array` - list of created identifiers | optional | if identifiers is not specified, its should be autogenerated on application level | if regular record exist or can't be created it should be pass it and start create next one |
| Update | `array`\|`\ArrayObject`\|`BaseDto`\|`object` | - | `array`\|`\ArrayObject`\|`BaseDto`\|`object` | required | - | - |
| MultiUpdate | `array[]`\|`\ArrayObject[]`\|`BaseDto[]`\|`object` | - | `array` - list of updated records | required | - | if regular record is not exist or record can't be updated it should pass it and start update next one |
| QueriedUpdate | `array`\|`\ArrayObject`\|`BaseDto`\|`object`, `Query` | - | `array` | forbidden | - | if regular record is not exist or record can't be updated it should pass it and start update next one |
| Rewrite | `array`\|`\ArrayObject`\|`BaseDto`\|`object` | - | `array`\|`\ArrayObject`\|`BaseDto` - rewrote record | optional | - | if identifier is not specified, it should be autogenerated on application level |
| Delete | `int`\|`string` | - | `array`\|`\ArrayObject`\|`BaseDto`\|`object` | required | - | - |
| QueriedDelete | `Query` | - | `array` - list of deleted records | forbidden | - | if regular record is not exist or record can't be deleted it should pass it and start delete next one |

### DataStoresInterface

| Name (operation) | Request shape req | Request shape optional | Response shape | id semantics | preconditions | notes |
| --- | --- | --- | --- | --- | --- | --- |
| Create | associated `array` | bool `$rewriteIfExist` - can item be rewrote if same 'id' exist | `array` created item | optional | If `$itemData['id']` is not set or `$itemData['id']===null`, item will be insert with autoincrement primary key | If  `$itemData['id'] !== null`, item set with that 'id'.<br>If item with same 'id' already exist - method will throw exception, but if `$rewriteIfExist = true` item will be rewrote |
| Update | associated `array` | bool `$createIfAbsent` - can item be created if same 'id' is absent in the store | `array` updated or inserted item | required | - | A fields which don't present in request will not be changed in item in the store. |
| Delete | `int`\|`string` | - | `array` from elements or null is not support | required | - | Method do nothing if item with that id is absent |
| DeleteAll | - | - | `int` number of deleted items or null if object doesn't support it | forbidden | - | Delete all Items |

## Abstraction

- **DataStoreAbstract implements both interfaces - DataStoreInterface & DataStoresInterface**
- **Realizations extends DataStoreAbstract**

| Name (operation) | Request shape | Response shape | id semantics | preconditions | notes |
| --- | --- | --- | --- | --- | --- |
| Has | `id` | `bool` | required | id type - `integer` \| `double` \| `string` | has record |
| Read | `id` | `array` | required | id type - `integer` \| `double` \| `string` | uses query request with Equal condition |
| GetIdentifier | - | `"id"` | - | - | - |
| Query | `Query` | `array` | forbidden | only sort ASC & DESC (+ & -) | read by RQL (where, limit, sort, groupby, select) |
| Create | `$itemData`, `$rewriteIfExist` (optional, false by default) | - | - | abstract public function (contract to release in heirs) | - |
| MultiCreate | `array` | `array` - updated Ids | - | bunch of creates | ignore (continue) if record not created |
| Update | `$itemData`, `$createIfAbsent` (optional, false by default) | - | - | abstract public function (contract to release in heirs) | - |
| MultiUpdate | `array` | `array` - updated Ids | - | bunch of updates | ignore (continue) if record not updated |
| QueriedUpdate | `$record`, `Query` | `array` - updated Ids | forbidden | query - then bunch of updates | ignore (continue) if record not updated |
| DeleteAll | - | `int` - deleted items number | - | bunch of deletes | - |
| Rewrite | `array` | `array` | required | - | create (if datastore has record with rewriteIfExist flag) |
| MultiRewrite | `array[]` | `array` | required | bunch of rewrite's | ignore (continue) if record not rewrited |
| Delete | `id` | - | required | abstract public function (contract to release in heirs) | - |
| QueriedDelete | `Query` | `array` - deleted ids | forbidden | bunch of deletes | ignore (continue) if record not deleted |
| Count | - | `int` | - | - | items in datastore |

## Realizations

| Name (operation) | DbTable | Notes | Preconditions | CsvBase | Memory | HttpClient |
| --- | --- | --- | --- | --- | --- | --- |
| Read | ✅ | - | identifier is only integer, double or string | ✅ | ✅ | ✅ |
| GetIdentifier | ❌ | - | - | ❌ | ❌ | ✅ |
| Query | ✅ | - | - | ❌ | ❌ | ✅ |
| Create | ✅ | Option 'rewriteIfExist' is no more use, E_DEPRECATED | - | ✅ | ✅ | ✅ |
| MultiCreate | ✅ | - | - | ❌ | ❌ | ✅ |
| Update | ✅ | Option 'createIfAbsent' is no more use, E_DEPRECATED | Item must has primary key | ✅ | ✅ | ✅ |
| MultiUpdate | ❌ | - | - | ❌ | ❌ | ❌ |
| QueriedUpdate | ✅ | using SELECT FOR UPDATE<br>rollback after any error | Expected non-empty associative array for update fields<br>requires limit<br>does not support select or groupBy<br>Primary key must not be present in queriedUpdate body | ❌ | ❌ | ❌ |
| DeleteAll | ✅ | - | - | ✅ | ✅ | ❌ |
| Rewrite | ❌ | - | - | ❌ | ❌ | ❌ |
| MultiRewrite | ❌ | - | - | ❌ | ❌ | ❌ |
| Delete | ✅ | - | identifier is only integer, double or string | ✅ | ✅ | ✅ |
| QueriedDelete | ✅ | - | Only where clause allowed for operation | ❌ | ❌ | ❌ |
| Count | ✅ | SELECT COUNT(*) AS count FROM table | - | ✅ | ✅ | ❌ |

## HTTP callable

| HTTP method | PHP method                                   | Handler | Request | Body | Description | Request features |
| --- |----------------------------------------------| --- | --- | --- | --- | --- |
| HEAD | `getIdentifier()`                            | HeadHandler | HEAD / | any | get PK | - |
| GET | `read($id)`                                  | ReadHandler | GET /{$id} | any | Read record by PK | - |
| GET | `query(Query $query)`                        | QueryHandler | GET /?rql | any | Read records by RQL filter | allowed withContentRange header (items and offset) |
| GET | none                                         | DownloadCsvHandler | GET /?rql | any | Obtaining datastore content in CSV format<br>Header will be changed to standarst (text/csv) in next releases. | - HEADER = 'download'<br>- limit in rql will be changed by server - you'll get all the content of DataStore |
| POST | `create($itemData, $rewriteIfExist = false)` | CreateHandler | POST / | {<br>"id":"value" (PK),<br>notNull fields<br>} | Creating a record | allowed overwriteMode - the ability to re-create a record if such a PK already exists |
| POST | `multiCreate($records)`                      | MultiCreateHandler | POST / | [<br>{create},<br>{create}<br>] | Create multiple records by one request | если в дс не реализован метод, циклически create |
| PUT | `update($itemData, $createIfAbsent = false)` | UpdateHandler | PUT /{$id} (либо в body id} | {<br>"field":"value"<br>} | partial update, correct method is PATCH, will be fixed in next releases | - allowed overwriteMode - create an entry if the transferred PK does not yet have one<br>- If "id":"value" is specified in the request body, it takes precedence over the id from the path param |
| PATCH | `queriedUpdate($record, Query $query)`       | QueriedUpdateHandler | PATCH /?limit()&rql | {<br>"field":"value"<br>} | Partial update of records matching the RQL filter conditions | Limit required |
| PATCH | `refresh()`                                  | RefreshHandler | PATCH / | any | Refresh datastore contents | only if DataStore realisation implements RefreshableInterface |
| DELETE | `delete($id)`                                | DeleteHandler | DELETE /{$id} | any | Delete record by PK | - |
