# DataStore methods — внутренняя справка
С данной частью документации желательно ознакамливатся после изучения [общей документации](/docs/index.md) 

## Abstraction level
**Единый справочник возможностей DataStore, без привязки к HTTP и конкретной реализации**

- **[DataStoreAbstract](/src/DataStore/src/DataStore/DataStoreAbstract.php) implements both interfaces - DataStoreInterface & DataStoresInterface**
- **Realizations extends DataStoreAbstract**
- [**DataStoresInterface** - старый интерфейс, **DataStoreInterface** - более новый интерфейс](/docs/index.md#getting-started)

| Name (operation) | Request shape                                                 | Response shape               | Наличие id | preconditions                                             | notes                                                                                                                                                                                 |
|------------------|---------------------------------------------------------------|------------------------------|------------|-----------------------------------------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| Create           | `$itemData`, `$rewriteIfExist` (optional, `false` by default) | -                            | -          | `abstract public function` (contract to release in heirs) | -                                                                                                                                                                                     |
| MultiCreate      | `array` - массив объектов                                     | `array` - created rows id's  | -          | -                                                         | Циклическое использование операции создания записи, если запись не была создана - ошибка игнорируется и цикл продолжается                                                             |
| Read             | `id`                                                          | `array`                      | required   | id type - `integer` \| `double` \| `string`               | Использует `query` запрос с условием `Equal`                                                                                                                                          |
| Query            | `Query` - объект-контейнер результата парсинга RQL            | `array` - массив записей     | forbidden  | only sort ASC & DESC (+ & -)                              | Чтение с помощью `RQL` (`where`, `limit`, `sort`, `groupby`, `select`)                                                                                                                |
| Update           | `$itemData`, `$createIfAbsent` (optional, `false` by default) | -                            | -          | `abstract public function` (contract to release in heirs) | -                                                                                                                                                                                     |
| MultiUpdate      | `array` - массив объектов                                     | `array` - updated id's       | -          | -                                                         | Циклическое использование операции обновления записи, если запись не была обновлена - ошибка игнорируется и цикл продолжается                                                         |
| QueriedUpdate    | `$record`, `Query`                                            | `array` - updated id's       | forbidden  | -                                                         | Сначала используется поиск по фильтру (`query`) - затем циклическое использование операции обновления записи, если запись не была обновлена - ошибка игнорируется и цикл продолжается |
| Delete           | `id`                                                          | -                            | required   | `abstract public function` (contract to release in heirs) | -                                                                                                                                                                                     |
| QueriedDelete    | `Query`                                                       | `array` - deleted id's       | forbidden  | -                                                         | Сначала используется поиск по фильтру (`query`) - затем циклическое использование операции удаление записи, если запись не была удалена - ошибка игнорируется и цикл продолжается     |
| DeleteAll        | -                                                             | `int` - deleted items number | -          | -                                                         | Циклическое использование операции удаления записи, если запись не была удалена - ошибка игнорируется и цикл продолжается                                                             |
| Has              | `id` - идентификатор записи                                   | `bool`                       | required   | id type - `integer` \| `double` \| `string`               | Проверка наличия записи в датасторе                                                                                                                                                   |
| GetIdentifier    | -                                                             | `"id"` - PK identifier       | -          | -                                                         | Получение идентификатора датастора                                                                                                                                                    |
| Count            | -                                                             | `int`                        | -          | -                                                         | Количество записей в датасторе                                                                                                                                                        |
| Rewrite          | `array` - объект                                              | create result                | required   | -                                                         | Использование операции создания записи (если в датасторе уже присутствует такая запись, то добавляется булев флаг `rewriteIfExist`со значением `true`)                                |
| MultiRewrite     | `array[]`                                                     | `array` - rewrote id's       | required   | -                                                         | Циклическое использование операции `rewrite`, если запись не была перезаписана - ошибка игнорируется и цикл продолжается                                                              |

## Realizations

| Name (operation) | [DbTable](/src/DataStore/src/DataStore/DbTable.php) | Notes                                                | Preconditions                                                                                                                                                           | [CsvBase](/src/DataStore/src/DataStore/CsvBase.php) | [Memory](/src/DataStore/src/DataStore/Memory.php) | [HttpClient](/src/DataStore/src/DataStore/HttpClient.php) | Notes                                                                                                                                                                                                                      |
|------------------|-----------------------------------------------------|------------------------------------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------|-----------------------------------------------------|---------------------------------------------------|-----------------------------------------------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| Create           | ✅                                                   | Option 'rewriteIfExist' is no more use, E_DEPRECATED | Ожидается объект(массив первой степени вложенности) в качестве аргумента                                                                                                | ✅                                                   | ✅                                                 | ✅                                                         | Option 'rewriteIfExist' is no more use, E_DEPRECATED                                                                                                                                                                       |
| MultiCreate      | ✅                                                   | -                                                    | Ожидается массив объектов в качестве аргумента                                                                                                                          | ❌                                                   | ❌                                                 | ✅                                                         | Сначала отправляется запрос на получение метаданных (HEAD)<br>Запрос на пакетное создание записей выполняется если серверная часть для этого датастора поддерживает операцию (проверяется по наличию кастомного заголовка) |
| Read             | ✅                                                   | -                                                    | identifier is only integer, double or string                                                                                                                            | ✅                                                   | ✅                                                 | ✅                                                         | -                                                                                                                                                                                                                          |
| Query            | ✅                                                   | -                                                    | Ожидается объект-контейнер результата парсинга RQL в качестве аргумента                                                                                                 | ❌                                                   | ❌                                                 | ✅                                                         | -                                                                                                                                                                                                                          |
| Update           | ✅                                                   | Option 'createIfAbsent' is no more use, E_DEPRECATED | Id (PK) обязателен                                                                                                                                                      | ✅                                                   | ✅                                                 | ✅                                                         | Option 'createIfAbsent' is no more use, E_DEPRECATED<br>Id (PK) обязателен                                                                                                                                                 |
| MultiUpdate      | ❌                                                   | -                                                    | -                                                                                                                                                                       | ❌                                                   | ❌                                                 | ❌                                                         | -                                                                                                                                                                                                                          |
| QueriedUpdate    | ✅                                                   | Using SELECT FOR UPDATE<br>rollback after any error  | Expected non-empty associative array for update fields<br>Requires limit<br>Does not support select or groupBy<br>Primary key must not be present in queriedUpdate body | ❌                                                   | ❌                                                 | ❌                                                         | -                                                                                                                                                                                                                          |
| Delete           | ✅                                                   | -                                                    | identifier is only integer, double or string                                                                                                                            | ✅                                                   | ✅                                                 | ✅                                                         | -                                                                                                                                                                                                                          |
| QueriedDelete    | ✅                                                   | -                                                    | Only where clause allowed for operation                                                                                                                                 | ❌                                                   | ❌                                                 | ❌                                                         | -                                                                                                                                                                                                                          |
| DeleteAll        | ✅                                                   | -                                                    | -                                                                                                                                                                       | ✅                                                   | ✅                                                 | ❌                                                         | -                                                                                                                                                                                                                          |
| GetIdentifier    | ❌                                                   | -                                                    | -                                                                                                                                                                       | ❌                                                   | ❌                                                 | ✅                                                         | -                                                                                                                                                                                                                          |
| Count            | ✅                                                   | SELECT COUNT(*) AS count FROM table                  | -                                                                                                                                                                       | ✅                                                   | ✅                                                 | ❌                                                         | -                                                                                                                                                                                                                          |
| Rewrite          | ❌                                                   | -                                                    | -                                                                                                                                                                       | ❌                                                   | ❌                                                 | ❌                                                         | -                                                                                                                                                                                                                          |
| MultiRewrite     | ❌                                                   | -                                                    | -                                                                                                                                                                       | ❌                                                   | ❌                                                 | ❌                                                         | -                                                                                                                                                                                                                          |

## HTTP callable

| HTTP method | PHP method                                    | Handler                                                                                | Request                    | Body                                           | Description                                                                                                   | Request features                                                                                                                                                                                 |
|-------------|-----------------------------------------------|----------------------------------------------------------------------------------------|----------------------------|------------------------------------------------|---------------------------------------------------------------------------------------------------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| POST        | `create($itemData, $rewriteIfExist = false)`  | [CreateHandler](/src/DataStore/src/Middleware/Handler/CreateHandler.php)               | POST /                     | {<br>"id":"value" (PK),<br>notNull fields<br>} | Creating a record                                                                                             | Allowed `overwriteMode` - the ability to re-create a record if such a PK already exists                                                                                                          |
| POST        | `multiCreate($records)`                       | [MultiCreateHandler](/src/DataStore/src/Middleware/Handler/MultiCreateHandler.php)     | POST /                     | [<br>{create},<br>{create}<br>]                | Create multiple records by one request                                                                        | Если в датасторе не реализован метод, циклически выполняется операция `create`                                                                                                                   |
| GET         | `read($id)`                                   | [ReadHandler](/src/DataStore/src/Middleware/Handler/ReadHandler.php)                   | GET /{$id}                 | any                                            | Read record by PK                                                                                             | -                                                                                                                                                                                                |
| GET         | `query(Query $query)`                         | [QueryHandler](/src/DataStore/src/Middleware/Handler/QueryHandler.php)                 | GET /?rql                  | any                                            | Read records by RQL filter                                                                                    | Allowed `withContentRange` header (items and offset)                                                                                                                                             |
| PUT         | `update($itemData, $createIfAbsent = false)`  | [UpdateHandler](/src/DataStore/src/Middleware/Handler/UpdateHandler.php)               | PUT /{$id} (или id в body} | {<br>"field":"value"<br>}                      | partial update, correct method is PATCH, will be fixed in next releases                                       | Allowed `overwriteMode` - create an entry if the transferred PK does not yet have one<br>If `"id":"value"` is specified in the request body, it takes precedence over the id from the path param |
| PATCH       | `queriedUpdate($record, Query $query)`        | [QueriedUpdateHandler](/src/DataStore/src/Middleware/Handler/QueriedUpdateHandler.php) | PATCH /?limit()&rql        | {<br>"field":"value"<br>}                      | Partial update of records matching the RQL filter conditions                                                  | Limit required                                                                                                                                                                                   |
| DELETE      | `delete($id)`                                 | [DeleteHandler](/src/DataStore/src/Middleware/Handler/DeleteHandler.php)               | DELETE /{$id}              | any                                            | Delete record by PK                                                                                           | -                                                                                                                                                                                                |
| HEAD        | `getIdentifier()`                             | [HeadHandler](/src/DataStore/src/Middleware/Handler/HeadHandler.php)                   | HEAD /                     | any                                            | Get PK & metadata in headers                                                                                  | -                                                                                                                                                                                                |
| GET         | none                                          | [DownloadCsvHandler](/src/DataStore/src/Middleware/Handler/DownloadCsvHandler.php)     | GET /?rql                  | any                                            | Obtaining datastore content in CSV format<br>Header will be changed to standarst (text/csv) in next releases. | Header = `download:csv`<br>Limit in rql will be changed by server - you'll get all the content of DataStore                                                                                      |
| PATCH       | `refresh()`                                   | [RefreshHandler](/src/DataStore/src/Middleware/Handler/RefreshHandler.php)             | PATCH /                    | any                                            | Refresh datastore contents                                                                                    | Only if DataStore realisation implements RefreshableInterface                                                                                                                                    |
