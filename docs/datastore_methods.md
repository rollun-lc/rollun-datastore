# DataStore methods — внутренняя справка
С данной частью документации желательно ознакамливатся после изучения [общей документации](/docs/index.md) 

## Минимальная терминология
- **`PK`** - Primary Key
- **`abstract public function`** - контракт, которой обязует реализовать данный метод в классах-наследниках
- **`RQL`** - Recourse Query Language

## Abstraction level
**Единый справочник возможностей DataStore, без привязки к HTTP и конкретной реализации**

- **[DataStoreAbstract](/src/DataStore/src/DataStore/DataStoreAbstract.php) implements both interfaces - DataStoreInterface & DataStoresInterface**
- **Realizations extends DataStoreAbstract**
- [**DataStoresInterface** - старый интерфейс, **DataStoreInterface** - более новый интерфейс](/docs/index.md#getting-started)

| Название (операция) | Структура запроса                                                                    | Структура ответа                                          | Наличие id | Предусловия                                                      | Примечание                                                                                                                                                                            |
|---------------------|--------------------------------------------------------------------------------------|-----------------------------------------------------------|------------|------------------------------------------------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| Create              | `$itemData`, `$rewriteIfExist` (опционально, имеет значение `false` по умолчанию)    | -                                                         | -          | `abstract public function`                                       | -                                                                                                                                                                                     |
| MultiCreate         | `array` - массив объектов                                                            | `array` - идентификаторы созданных записей                | -          | -                                                                | Циклическое использование операции создания записи, если запись не была создана - ошибка игнорируется и цикл продолжается                                                             |
| Read                | `id`                                                                                 | `array`                                                   | required   | Id должен быть следующего типа: `integer`, `double` или `string` | Использует `query` запрос с условием `Equal`                                                                                                                                          |
| Query               | `Query` - объект-контейнер результата парсинга RQL                                   | `array` - массив записей                                  | forbidden  | Сортировка может быть только ASC & DESC (+ & -)                  | Чтение с помощью `RQL` (`where`, `limit`, `sort`, `groupby`, `select`)                                                                                                                |
| Update              | `$itemData`, `$createIfAbsent` (опционально, имеет значение `false` по умолчанию)    | -                                                         | -          | `abstract public function`                                       | -                                                                                                                                                                                     |
| MultiUpdate         | `array` - массив объектов                                                            | `array` - идентификаторы обновленных записей              | -          | -                                                                | Циклическое использование операции обновления записи, если запись не была обновлена - ошибка игнорируется и цикл продолжается                                                         |
| QueriedUpdate       | `$record`, `Query`                                                                   | `array` - идентификаторы обновленных записей              | forbidden  | -                                                                | Сначала используется поиск по фильтру (`query`) - затем циклическое использование операции обновления записи, если запись не была обновлена - ошибка игнорируется и цикл продолжается |
| Delete              | `id`                                                                                 | -                                                         | required   | `abstract public function`                                       | -                                                                                                                                                                                     |
| QueriedDelete       | `Query`                                                                              | `array` - идентификаторы удаленных записей                | forbidden  | -                                                                | Сначала используется поиск по фильтру (`query`) - затем циклическое использование операции удаление записи, если запись не была удалена - ошибка игнорируется и цикл продолжается     |
| DeleteAll           | -                                                                                    | `int` - количество удаленных записей                      | -          | -                                                                | Циклическое использование операции удаления записи, если запись не была удалена - ошибка игнорируется и цикл продолжается                                                             |
| Has                 | `id` - идентификатор записи                                                          | `bool`                                                    | required   | Id должен быть следующего типа: `integer`, `double` или `string` | Проверка наличия записи в DataStore                                                                                                                                                   |
| GetIdentifier       | -                                                                                    | `"id"` - PK идентификатор                                 | -          | -                                                                | Получение идентификатора DataStore                                                                                                                                                    |
| Count               | -                                                                                    | `int`                                                     | -          | -                                                                | Количество записей в DataStore                                                                                                                                                        |
| Rewrite             | `array` - объект                                                                     | Тот же результат, что будет получен и при операции create | required   | -                                                                | Использование операции создания записи (если в DataStore уже присутствует такая запись, то добавляется булев флаг `rewriteIfExist` со значением `true`)                               |
| MultiRewrite        | `array[]`                                                                            | `array` - идентификаторы перезаписанных записей           | required   | -                                                                | Циклическое использование операции `rewrite`, если запись не была перезаписана - ошибка игнорируется и цикл продолжается                                                              |

## Realizations

| Название (операция)  | [DbTable](/src/DataStore/src/DataStore/DbTable.php) | Примечание                                                                           | Предусловия                                                                                                                                                                                 | [CsvBase](/src/DataStore/src/DataStore/CsvBase.php) | [Memory](/src/DataStore/src/DataStore/Memory.php) | [HttpClient](/src/DataStore/src/DataStore/HttpClient.php) | Примечание                                                                                                                                                                                                                 |
|----------------------|-----------------------------------------------------|--------------------------------------------------------------------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|-----------------------------------------------------|---------------------------------------------------|-----------------------------------------------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| Create               | ✅                                                   | Опция 'rewriteIfExist' больше не используется, ошибка уровня E_DEPRECATED            | Ожидается объект (массив первой степени вложенности) в качестве аргумента                                                                                                                   | ✅                                                   | ✅                                                 | ✅                                                         | Опция 'rewriteIfExist' больше не используется, ошибка уровня E_DEPRECATED                                                                                                                                                  |
| MultiCreate          | ✅                                                   | -                                                                                    | Ожидается массив объектов в качестве аргумента                                                                                                                                              | ❌                                                   | ❌                                                 | ✅                                                         | Сначала отправляется запрос на получение метаданных (HEAD)<br>Запрос на пакетное создание записей выполняется если серверная часть для этого DataStore поддерживает операцию (проверяется по наличию кастомного заголовка) |
| Read                 | ✅                                                   | -                                                                                    | Id должен быть следующего типа: `integer`, `double` или `string`                                                                                                                            | ✅                                                   | ✅                                                 | ✅                                                         | -                                                                                                                                                                                                                          |
| Query                | ✅                                                   | -                                                                                    | Ожидается объект-контейнер результата парсинга RQL в качестве аргумента                                                                                                                     | ❌                                                   | ❌                                                 | ✅                                                         | -                                                                                                                                                                                                                          |
| Update               | ✅                                                   | Опция 'createIfAbsent' больше не используется, ошибка уровня E_DEPRECATED            | Id (PK) обязателен                                                                                                                                                                          | ✅                                                   | ✅                                                 | ✅                                                         | Опция 'createIfAbsent' больше не используется, ошибка уровня E_DEPRECATED<br>Id (PK) обязателен                                                                                                                            |
| MultiUpdate          | ❌                                                   | -                                                                                    | -                                                                                                                                                                                           | ❌                                                   | ❌                                                 | ❌                                                         | -                                                                                                                                                                                                                          |
| QueriedUpdate        | ✅                                                   | Реализовано через запрос SELECT FOR UPDATE<br>При любой ошибке, выполняется rollback | Ожидается непустой ассоциативный массив для обновления полей<br>Требуется наличие `limit` в RQL<br>Не поддерживаются RQL фильтры `select` или `groupBy`<br>PK должен отсутствовать в `body` | ❌                                                   | ❌                                                 | ❌                                                         | -                                                                                                                                                                                                                          |
| Delete               | ✅                                                   | -                                                                                    | Id должен быть следующего типа: `integer`, `double` или `string`                                                                                                                            | ✅                                                   | ✅                                                 | ✅                                                         | -                                                                                                                                                                                                                          |
| QueriedDelete        | ✅                                                   | -                                                                                    | Для операции допускается только группа условий `where` из RQL                                                                                                                               | ❌                                                   | ❌                                                 | ❌                                                         | -                                                                                                                                                                                                                          |
| DeleteAll            | ✅                                                   | -                                                                                    | -                                                                                                                                                                                           | ✅                                                   | ✅                                                 | ❌                                                         | -                                                                                                                                                                                                                          |
| GetIdentifier        | ❌                                                   | -                                                                                    | -                                                                                                                                                                                           | ❌                                                   | ❌                                                 | ✅                                                         | -                                                                                                                                                                                                                          |
| Count                | ✅                                                   | Реализовано через запрос SELECT COUNT(*) AS count FROM table                         | -                                                                                                                                                                                           | ✅                                                   | ✅                                                 | ❌                                                         | -                                                                                                                                                                                                                          |
| Rewrite              | ❌                                                   | -                                                                                    | -                                                                                                                                                                                           | ❌                                                   | ❌                                                 | ❌                                                         | -                                                                                                                                                                                                                          |
| MultiRewrite         | ❌                                                   | -                                                                                    | -                                                                                                                                                                                           | ❌                                                   | ❌                                                 | ❌                                                         | -                                                                                                                                                                                                                          |

## HTTP callable
Данная таблица покрывает только особенности запросов к **обработчикам**. Особенности, скрытые за методом для каждой из реализаций DataStore, остаются актуальными.

| HTTP метод | PHP метод                                    | Соответствующий обработчик запроса                                                     | Формат запроса             | Тело запроса                                   | Описание                                                                                                                                                     | Дополнительные возможности/особенности запроса                                                                                                                                           |
|------------|----------------------------------------------|----------------------------------------------------------------------------------------|----------------------------|------------------------------------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| POST       | `create($itemData, $rewriteIfExist = false)` | [CreateHandler](/src/DataStore/src/Middleware/Handler/CreateHandler.php)               | POST /                     | {<br>"id":"value" (PK),<br>notNull fields<br>} | Создание записи                                                                                                                                              | Можно задать `overwriteMode` - возможность пересоздать запись, если такой PK уже существует                                                                                              |
| POST       | `multiCreate($records)`                      | [MultiCreateHandler](/src/DataStore/src/Middleware/Handler/MultiCreateHandler.php)     | POST /                     | [<br>{create},<br>{create}<br>]                | Создание множества записей одним запросом                                                                                                                    | Если в датасторе не реализован метод, циклически выполняется операция `create`                                                                                                           |
| GET        | `read($id)`                                  | [ReadHandler](/src/DataStore/src/Middleware/Handler/ReadHandler.php)                   | GET /{$id}                 | any                                            | Чтение записи по PK                                                                                                                                          | -                                                                                                                                                                                        |
| GET        | `query(Query $query)`                        | [QueryHandler](/src/DataStore/src/Middleware/Handler/QueryHandler.php)                 | GET /?rql                  | any                                            | Чтение записей с помощью RQL фильтра                                                                                                                         | Можно задать `withContentRange` header (`items` & `offset`)                                                                                                                              |
| PUT        | `update($itemData, $createIfAbsent = false)` | [UpdateHandler](/src/DataStore/src/Middleware/Handler/UpdateHandler.php)               | PUT /{$id} (или id в body} | {<br>"field":"value"<br>}                      | Частичное обновление записи, правильный метод запроса - PATCH, это будет исправлено в следующих версиях                                                      | Можно задать `overwriteMode` - создать запись, евле её не существует по переданному PK<br>Если `"id":"value"` указан в теле запроса, он имеет приоритет над id из параметра пути запроса |
| PATCH      | `queriedUpdate($record, Query $query)`       | [QueriedUpdateHandler](/src/DataStore/src/Middleware/Handler/QueriedUpdateHandler.php) | PATCH /?limit()&rql        | {<br>"field":"value"<br>}                      | Частичное обновление записей, соответствующих условиям фильтра RQL                                                                                           | Требуется RQL фильтр `limit` в запросе                                                                                                                                                   |
| DELETE     | `delete($id)`                                | [DeleteHandler](/src/DataStore/src/Middleware/Handler/DeleteHandler.php)               | DELETE /{$id}              | any                                            | Удаление записи по PK                                                                                                                                        | -                                                                                                                                                                                        |
| HEAD       | `getIdentifier()`                            | [HeadHandler](/src/DataStore/src/Middleware/Handler/HeadHandler.php)                   | HEAD /                     | any                                            | Получение PK и метаданных датастора в заголовках                                                                                                             | -                                                                                                                                                                                        |
| GET        | none                                         | [DownloadCsvHandler](/src/DataStore/src/Middleware/Handler/DownloadCsvHandler.php)     | GET /?rql                  | any                                            | Получение содержимого датастора в формате CSV файла<br>Заголовок запроса будет изменен на соответствущий стандартам (`Accept:text/csv`) в следующих релизах. | Header должен быть `download:csv`<br>RQL фильтр `limit` будет изменен сервером  - вы получите все содержимое DataStore                                                                   |
| PATCH      | `refresh()`                                  | [RefreshHandler](/src/DataStore/src/Middleware/Handler/RefreshHandler.php)             | PATCH /                    | any                                            | Обновление содержимого датастора                                                                                                                             | Только если реализация DataStore implements RefreshableInterface                                                                                                                         |
